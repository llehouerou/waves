name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y libasound2-dev

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Install tools
        run: |
          go install github.com/incu6us/goimports-reviser/v3@latest
          go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest

      - name: Format
        run: make fmt

      - name: Lint
        run: make lint

      - name: Test
        run: make test

      - name: Generate AI Release Notes
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Get commits since last tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "$PREVIOUS_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s" "$PREVIOUS_TAG"..HEAD)
          else
            COMMITS=$(git log --pretty=format:"- %s")
          fi

          # Build the JSON payload
          SYSTEM_PROMPT="You are a release notes writer for Waves, a terminal music player.

          Given a list of git commits, write release notes with:

          1. A 2-3 sentence intro summarizing what's new in this release (written for end users, not developers)

          2. A categorized list with these sections (only include sections that have items):
             - **New Features** - new functionality
             - **Improvements** - enhancements to existing features
             - **Bug Fixes** - fixes

          Rules:
          - Rewrite commit messages in user-friendly language (e.g., \"feat(player): add gapless playback\" becomes \"Added gapless playback between tracks\")
          - Skip commits that don't affect users (refactors, tests, docs, CI changes)
          - Be concise - one line per change
          - Don't include commit hashes or technical jargon"

          PAYLOAD=$(jq -n \
            --arg model "claude-haiku-4-20250514" \
            --arg system "$SYSTEM_PROMPT" \
            --arg commits "$COMMITS" \
            '{
              model: $model,
              max_tokens: 1024,
              system: $system,
              messages: [{ role: "user", content: $commits }]
            }')

          # Call Claude API
          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -H "content-type: application/json" \
            -d "$PAYLOAD")

          # Extract and write release notes
          echo "$RESPONSE" | jq -r '.content[0].text' > release-notes.md

          echo "Generated release notes:"
          cat release-notes.md

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
